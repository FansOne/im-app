'use strict';

var _webim_wx = require('./webim_wx.js');

var _webim_wx2 = _interopRequireDefault(_webim_wx);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// 需要用到的参数
var accountMode, // 帐号模式，0 - 独立模式 1 - 托管模式
accountType, // 帐号体系集成中的 accountType，必填
sdkAppID, // 用户标识接入 SDK 的应用 ID，必填
selType, // 会话类型 webim.MSG_MAX_LENGTH.C2C - 私聊 webim.SESSION_TYPE.GROUP - 群聊
imId, // 用户的 id
imName, // 用户的 im 名称
imAvatarUrl, // 用户的 im 头像 url
friendId, // 好友 id
friendName, // 好友昵称
friendAvatarUrl, // 好友头像
currentMsgsArray, // 当前消息数组 用于增删改查
contactListThat, // 当前会话列表页面对象
chatThat, // 当前聊天好友页面对象
selSess;

/**
 * 登录 im
 */
function login(that, app, callback) {
  _webim_wx2.default.Log.warn('开始登录 im');
  if (!callback) callback = function callback() {};
  if (!app.im.imId || !app.im.userSig) {
    _webim_wx2.default.Log.error("登录 im 失败[im 数据未初始化完毕]");
    return;
  }
  // 获取当前用户身份
  var loginInfo = {
    'sdkAppID': app.im.sdkAppID, //	用户标识接入 SDK 的应用 ID，必填
    'appIDAt3rd': app.im.sdkAppID, // App 用户使用 OAuth 授权体系分配的 Appid，必填
    'accountType': app.im.accountType, // 帐号体系集成中的 accountType，必填
    'identifier': app.im.imId, // 当前用户帐号，必填
    'identifierNick': app.im.imName, // 当前用户昵称，选填
    'userSig': app.im.userSig // 鉴权 Token，必填

    // 指定监听事件
  };var listeners = {
    "onConnNotify": onConnNotify, // 监听连接状态回调变化事件,必填
    "onMsgNotify": onMsgNotify // 监听新消息回调变化事件,必填

    //其他对象，选填
  };var options = {
    'isAccessFormalEnv': true, // 是否访问正式环境，默认访问正式，选填
    'isLogOn': true // 是否开启控制台打印日志,默认开启，选填

    // sdk 登录（独立模式）
  };_webim_wx2.default.login(loginInfo, listeners, options, function (resp) {
    _webim_wx2.default.Log.warn('登录 im 成功');
    callback();
  }, function (err) {
    _webim_wx2.default.Log.error("登录 im 失败", err.ErrorInfo);
  });
}

/**
 * 监听连接状态回调变化事件
 */
function onConnNotify(resp) {
  switch (resp.ErrorCode) {
    case _webim_wx2.default.CONNECTION_STATUS.ON:
      _webim_wx2.default.Log.warn('连接状态正常...');
      break;
    case _webim_wx2.default.CONNECTION_STATUS.OFF:
      _webim_wx2.default.Log.warn('连接已断开，无法收到新消息，请检查下你的网络是否正常');
      break;
    default:
      _webim_wx2.default.Log.error('未知连接状态,status=' + resp.ErrorCode);
      break;
  }
}

/**
 * 监听新消息（初始化时会获取所有会话数组，随后只获取新会话数组）
 * newMsgList - 新消息数组
 */
function onMsgNotify(newMsgList) {
  var newMsg, session;
  // 如果有新消息，并且处在聊天界面上
  if (newMsgList && chatThat) {
    for (var j in newMsgList) {
      newMsg = newMsgList[j];
      if (chatThat && newMsg.getSession().id() == friendId) {
        selSess = newMsg.getSession();
        chatThat.addMessage(newMsg.elems[0].content.text, false, chatThat);
      }
    }
  }
  // 如果有新消息，并且处在会话列表界面上
  if (newMsgList && contactListThat) {
    contactListThat.initRecentContactList();
  }
}

/**
 * 获取聊天历史记录
 */
function getC2CHistoryMsgs(cbOk) {
  _webim_wx2.default.Log.warn('开始获取聊天历史记录');
  var that = this;
  currentMsgsArray = [];
  var reqMsgCount = 10; // 拉取消息条数
  var lastMsgTime = wx.setStorageSync('lastMsgTime') || 0; // 最后一次拉取历史消息的时间
  var msgKey = wx.getStorageSync('msgKey') || '';
  var options = {
    'Peer_Account': friendId, // 好友帐号
    'MaxCnt': reqMsgCount, // 拉取消息条数
    'LastMsgTime': lastMsgTime, // 最近的消息时间，即从这个时间点向前拉取历史消息
    'MsgKey': msgKey
    // 真正获取历史消息的方法 交由实际调用者处理数据
  };_webim_wx2.default.getC2CHistoryMsgs(options, function (resp) {
    cbOk(resp);
  });
  //消息已读上报，以及设置会话自动已读标记
  var sessMap = _webim_wx2.default.MsgStore.sessMap();
  for (var i in sessMap) {
    var sess = sessMap[i];
    if (friendId == sess.id()) {
      _webim_wx2.default.setAutoRead(sess, true, true);
    }
  }
  _webim_wx2.default.Log.warn('获取聊天历史纪录完毕');
}

/**
 * 发送消息(普通消息)
 */
function onSendMsg(msg, cbOk, cbErr) {
  //获取消息内容
  var msgtosend = msg;
  // 创建会话对象
  if (!selSess) {
    selSess = new _webim_wx2.default.Session(selType, friendId, friendName, friendAvatarUrl, Math.round(new Date().getTime() / 1000));
  }
  var isSend = true; // 是否为自己发送
  var seq = -1; // 消息序列，-1 表示 sdk 自动生成，用于去重
  var random = Math.round(Math.random() * 4294967296); // 消息随机数，用于去重
  var msgTime = Date.parse(new Date()) / 1000; // 消息时间戳
  var subType = _webim_wx2.default.C2C_MSG_SUB_TYPE.COMMON; // 消息子类型 c2c 消息时，参考 c2c 消息子类型对象：im.C2C_MSG_SUB_TYPE 
  // loginInfo.identifier 消息发送者账号,loginInfo.identifierNick 消息发送者昵称
  var msg = new _webim_wx2.default.Msg(selSess, isSend, seq, random, msgTime, imId, subType, imName);
  var textObj = new _webim_wx2.default.Msg.Elem.Text(msgtosend);
  msg.addText(textObj);
  _webim_wx2.default.sendMsg(msg, function (resp) {
    cbOk();
  }, function (err) {
    cbErr(err);
  });
}

/**
 * 初始化 im
 */
function init(opts) {
  accountMode = opts.accountMode;
  accountType = opts.accountType;
  sdkAppID = opts.sdkAppID;
  selType = opts.selType;
  imId = opts.imId;
  imName = opts.imName;
  imAvatarUrl = opts.imAvatarUrl;
  friendId = opts.friendId;
  friendName = opts.friendName;
  friendAvatarUrl = opts.friendAvatarUrl;
  contactListThat = opts.contactListThat;
  chatThat = opts.chatThat;
}

module.exports = {
  init: init,
  login: login,
  onMsgNotify: onMsgNotify,
  getC2CHistoryMsgs: getC2CHistoryMsgs,
  onSendMsg: onSendMsg
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImltX2hhbmRsZXIuanMiXSwibmFtZXMiOlsiYWNjb3VudE1vZGUiLCJhY2NvdW50VHlwZSIsInNka0FwcElEIiwic2VsVHlwZSIsImltSWQiLCJpbU5hbWUiLCJpbUF2YXRhclVybCIsImZyaWVuZElkIiwiZnJpZW5kTmFtZSIsImZyaWVuZEF2YXRhclVybCIsImN1cnJlbnRNc2dzQXJyYXkiLCJjb250YWN0TGlzdFRoYXQiLCJjaGF0VGhhdCIsInNlbFNlc3MiLCJsb2dpbiIsInRoYXQiLCJhcHAiLCJjYWxsYmFjayIsImltIiwiTG9nIiwid2FybiIsInVzZXJTaWciLCJlcnJvciIsImxvZ2luSW5mbyIsImxpc3RlbmVycyIsIm9uQ29ubk5vdGlmeSIsIm9uTXNnTm90aWZ5Iiwib3B0aW9ucyIsInJlc3AiLCJlcnIiLCJFcnJvckluZm8iLCJFcnJvckNvZGUiLCJDT05ORUNUSU9OX1NUQVRVUyIsIk9OIiwiT0ZGIiwibmV3TXNnTGlzdCIsIm5ld01zZyIsInNlc3Npb24iLCJqIiwiZ2V0U2Vzc2lvbiIsImlkIiwiYWRkTWVzc2FnZSIsImVsZW1zIiwiY29udGVudCIsInRleHQiLCJpbml0UmVjZW50Q29udGFjdExpc3QiLCJnZXRDMkNIaXN0b3J5TXNncyIsImNiT2siLCJyZXFNc2dDb3VudCIsImxhc3RNc2dUaW1lIiwid3giLCJzZXRTdG9yYWdlU3luYyIsIm1zZ0tleSIsImdldFN0b3JhZ2VTeW5jIiwic2Vzc01hcCIsIk1zZ1N0b3JlIiwiaSIsInNlc3MiLCJzZXRBdXRvUmVhZCIsIm9uU2VuZE1zZyIsIm1zZyIsImNiRXJyIiwibXNndG9zZW5kIiwiU2Vzc2lvbiIsIk1hdGgiLCJyb3VuZCIsIkRhdGUiLCJnZXRUaW1lIiwiaXNTZW5kIiwic2VxIiwicmFuZG9tIiwibXNnVGltZSIsInBhcnNlIiwic3ViVHlwZSIsIkMyQ19NU0dfU1VCX1RZUEUiLCJDT01NT04iLCJNc2ciLCJ0ZXh0T2JqIiwiRWxlbSIsIlRleHQiLCJhZGRUZXh0Iiwic2VuZE1z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QTNELHFCQUFHK0QsT0FBSCxDQUFXckIsR0FBWCxFQUFnQixVQUFVaEMsSUFBVixFQUFnQjtBQUM5Qm1CO0FBQ0QsR0FGRCxFQUVHLFVBQVVsQixHQUFWLEVBQWU7QUFDaEJnQyxVQUFNaEMsR0FBTjtBQUNELEdBSkQ7QUFLRDs7QUFFRDs7O0FBR0EsU0FBU3FELElBQVQsQ0FBY0MsSUFBZCxFQUFvQjtBQUNsQm5GLGdCQUFjbUYsS0FBS25GLFdBQW5CO0FBQ0FDLGdCQUFja0YsS0FBS2xGLFdBQW5CO0FBQ0FDLGFBQVdpRixLQUFLakYsUUFBaEI7QUFDQUMsWUFBVWdGLEtBQUtoRixPQUFmO0FBQ0FDLFNBQU8rRSxLQUFLL0UsSUFBWjtBQUNBQyxXQUFTOEUsS0FBSzlFLE1BQWQ7QUFDQUMsZ0JBQWM2RSxLQUFLN0UsV0FBbkI7QUFDQUMsYUFBVzRFLEtBQUs1RSxRQUFoQjtBQUNBQyxlQUFhMkUsS0FBSzNFLFVBQWxCO0FBQ0FDLG9CQUFrQjBFLEtBQUsxRSxlQUF2QjtBQUNBRSxvQkFBa0J3RSxLQUFLeEUsZUFBdkI7QUFDQUMsYUFBV3VFLEtBQUt2RSxRQUFoQjtBQUNEOztBQUVEd0UsT0FBT0MsT0FBUCxHQUFpQjtBQUNmSCxRQUFNQSxJQURTO0FBRWZwRSxTQUFPQSxLQUZRO0FBR2ZZLGVBQWFBLFdBSEU7QUFJZm9CLHFCQUFtQkEsaUJBSko7QUFLZmEsYUFBV0E7QUFMSSxDQUFqQiIsImZpbGUiOiJpbV9oYW5kbGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGltIGZyb20gJy4vd2ViaW1fd3gnXHJcblxyXG4vLyDpnIDopoHnlKjliLDnmoTlj4LmlbBcclxudmFyIGFjY291bnRNb2RlLCAvLyDluJDlj7fmqKHlvI/vvIwwIC0g54us56uL5qih5byPIDEgLSDmiZjnrqHmqKHlvI9cclxuICBhY2NvdW50VHlwZSwgLy8g5biQ5Y+35L2T57O76ZuG5oiQ5Lit55qEIGFjY291bnRUeXBl77yM5b+F5aGrXHJcbiAgc2RrQXBwSUQsIC8vIOeUqOaIt+agh+ivhuaOpeWFpSBTREsg55qE5bqU55SoIElE77yM5b+F5aGrXHJcbiAgc2VsVHlwZSwgLy8g5Lya6K+d57G75Z6LIHdlYmltLk1TR19NQVhfTEVOR1RILkMyQyAtIOengeiBiiB3ZWJpbS5TRVNTSU9OX1RZUEUuR1JPVVAgLSDnvqTogYpcclxuICBpbUlkLCAvLyDnlKjmiLfnmoQgaWRcclxuICBpbU5hbWUsIC8vIOeUqOaIt+eahCBpbSDlkI3np7BcclxuICBpbUF2YXRhclVybCwgLy8g55So5oi355qEIGltIOWktOWDjyB1cmxcclxuICBmcmllbmRJZCwgLy8g5aW95Y+LIGlkXHJcbiAgZnJpZW5kTmFtZSwgLy8g5aW95Y+L5pi156ewXHJcbiAgZnJpZW5kQXZhdGFyVXJsLCAvLyDlpb3lj4vlpLTlg49cclxuICBjdXJyZW50TXNnc0FycmF5LCAvLyDlvZPliY3mtojmga/mlbDnu4Qg55So5LqO5aKe5Yig5pS55p+lXHJcbiAgY29udGFjdExpc3RUaGF0LCAvLyDlvZPliY3kvJror53liJfooajpobXpnaLlr7nosaFcclxuICBjaGF0VGhhdCwgLy8g5b2T5YmN6IGK5aSp5aW95Y+L6aG16Z2i5a+56LGhXHJcbiAgc2VsU2Vzc1xyXG4gIFxyXG4vKipcclxuICog55m75b2VIGltXHJcbiAqL1xyXG5mdW5jdGlvbiBsb2dpbih0aGF0LCBhcHAsIGNhbGxiYWNrKSB7XHJcbiAgaW0uTG9nLndhcm4oJ+W8gOWni+eZu+W9lSBpbScpXHJcbiAgaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSAoKSA9PiB7fVxyXG4gIGlmICghYXBwLmltLmltSWQgfHwgIWFwcC5pbS51c2VyU2lnKSB7XHJcbiAgICBpbS5Mb2cuZXJyb3IoXCLnmbvlvZUgaW0g5aSx6LSlW2ltIOaVsOaNruacquWIneWni+WMluWujOavlV1cIilcclxuICAgIHJldHVyblxyXG4gIH1cclxuICAvLyDojrflj5blvZPliY3nlKjmiLfouqvku71cclxuICB2YXIgbG9naW5JbmZvID0ge1xyXG4gICAgJ3Nka0FwcElEJzogYXBwLmltLnNka0FwcElELCAvL1x055So5oi35qCH6K+G5o6l5YWlIFNESyDnmoTlupTnlKggSUTvvIzlv4XloatcclxuICAgICdhcHBJREF0M3JkJzogYXBwLmltLnNka0FwcElELCAvLyBBcHAg55So5oi35L2/55SoIE9BdXRoIOaOiOadg+S9k+ezu+WIhumFjeeahCBBcHBpZO+8jOW/heWhq1xyXG4gICAgJ2FjY291bnRUeXBlJzogYXBwLmltLmFjY291bnRUeXBlLCAvLyDluJDlj7fkvZPns7vpm4bmiJDkuK3nmoQgYWNjb3VudFR5cGXvvIzlv4XloatcclxuICAgICdpZGVudGlmaWVyJzogYXBwLmltLmltSWQsIC8vIOW9k+WJjeeUqOaIt+W4kOWPt++8jOW/heWhq1xyXG4gICAgJ2lkZW50aWZpZXJOaWNrJzogYXBwLmltLmltTmFtZSwgLy8g5b2T5YmN55So5oi35pi156ew77yM6YCJ5aGrXHJcbiAgICAndXNlclNpZyc6IGFwcC5pbS51c2VyU2lnLCAvLyDpibTmnYMgVG9rZW7vvIzlv4XloatcclxuICB9XHJcbiAgLy8g5oyH5a6a55uR5ZCs5LqL5Lu2XHJcbiAgdmFyIGxpc3RlbmVycyA9IHtcclxuICAgIFwib25Db25uTm90aWZ5XCI6IG9uQ29ubk5vdGlmeSwgLy8g55uR5ZCs6L+e5o6l54q25oCB5Zue6LCD5Y+Y5YyW5LqL5Lu2LOW/heWhq1xyXG4gICAgXCJvbk1zZ05vdGlmeVwiOiBvbk1zZ05vdGlmeSAvLyDnm5HlkKzmlrDmtojmga/lm57osIPlj5jljJbkuovku7Ys5b+F5aGrXHJcbiAgfVxyXG4gIC8v5YW25LuW5a+56LGh77yM6YCJ5aGrXHJcbiAgdmFyIG9wdGlvbnMgPSB7XHJcbiAgICAnaXNBY2Nlc3NGb3JtYWxFbnYnOiB0cnVlLCAvLyDmmK/lkKborr/pl67mraPlvI/njq/looPvvIzpu5jorqTorr/pl67mraPlvI/vvIzpgInloatcclxuICAgICdpc0xvZ09uJzogdHJ1ZSAvLyDmmK/lkKblvIDlkK/mjqfliLblj7DmiZPljbDml6Xlv5cs6buY6K6k5byA5ZCv77yM6YCJ5aGrXHJcbiAgfVxyXG4gIC8vIHNkayDnmbvlvZXvvIjni6znq4vmqKHlvI/vvIlcclxuICBpbS5sb2dpbihsb2dpbkluZm8sIGxpc3RlbmVycywgb3B0aW9ucywgZnVuY3Rpb24gKHJlc3ApIHtcclxuICAgIGltLkxvZy53YXJuKCfnmbvlvZUgaW0g5oiQ5YqfJylcclxuICAgIGNhbGxiYWNrKClcclxuICB9LCBmdW5jdGlvbiAoZXJyKSB7XHJcbiAgICBpbS5Mb2cuZXJyb3IoXCLnmbvlvZUgaW0g5aSx6LSlXCIsIGVyci5FcnJvckluZm8pXHJcbiAgfSlcclxufVxyXG5cclxuLyoqXHJcbiAqIOebkeWQrOi/nuaOpeeKtuaAgeWbnuiwg+WPmOWMluS6i+S7tlxyXG4gKi9cclxuZnVuY3Rpb24gb25Db25uTm90aWZ5KHJlc3ApIHtcclxuICBzd2l0Y2ggKHJlc3AuRXJyb3JDb2RlKSB7XHJcbiAgICBjYXNlIGltLkNPTk5FQ1RJT05fU1RBVFVTLk9OOlxyXG4gICAgICBpbS5Mb2cud2Fybign6L+e5o6l54q25oCB5q2j5bi4Li4uJylcclxuICAgICAgYnJlYWtcclxuICAgIGNhc2UgaW0uQ09OTkVDVElPTl9TVEFUVVMuT0ZGOlxyXG4gICAgICBpbS5Mb2cud2Fybign6L+e5o6l5bey5pat5byA77yM5peg5rOV5pS25Yiw5paw5raI5oGv77yM6K+35qOA5p+l5LiL5L2g55qE572R57uc5piv5ZCm5q2j5bi4JylcclxuICAgICAgYnJlYWtcclxuICAgIGRlZmF1bHQ6XHJcbiAgICAgIGltLkxvZy5lcnJvcign5pyq55+l6L+e5o6l54q25oCBLHN0YXR1cz0nICsgcmVzcC5FcnJvckNvZGUpXHJcbiAgICAgIGJyZWFrXHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog55uR5ZCs5paw5raI5oGv77yI5Yid5aeL5YyW5pe25Lya6I635Y+W5omA5pyJ5Lya6K+d5pWw57uE77yM6ZqP5ZCO5Y+q6I635Y+W5paw5Lya6K+d5pWw57uE77yJXHJcbiAqIG5ld01zZ0xpc3QgLSDmlrDmtojmga/mlbDnu4RcclxuICovXHJcbmZ1bmN0aW9uIG9uTXNnTm90aWZ5KG5ld01zZ0xpc3QpIHtcclxuICB2YXIgbmV3TXNnLCBzZXNzaW9uO1xyXG4gIC8vIOWmguaenOacieaWsOa2iOaBr++8jOW5tuS4lOWkhOWcqOiBiuWkqeeVjOmdouS4ilxyXG4gIGlmKG5ld01zZ0xpc3QgJiYgY2hhdFRoYXQpIHtcclxuICAgIGZvciAodmFyIGogaW4gbmV3TXNnTGlzdCkge1xyXG4gICAgICBuZXdNc2cgPSBuZXdNc2dMaXN0W2pdO1xyXG4gICAgICBpZiAoY2hhdFRoYXQgJiYgbmV3TXNnLmdldFNlc3Npb24oKS5pZCgpID09IGZyaWVuZElkKSB7XHJcbiAgICAgICAgc2VsU2VzcyA9IG5ld01zZy5nZXRTZXNzaW9uKClcclxuICAgICAgICBjaGF0VGhhdC5hZGRNZXNzYWdlKG5ld01zZy5lbGVtc1swXS5jb250ZW50LnRleHQsIGZhbHNlLCBjaGF0VGhhdClcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvLyDlpoLmnpzmnInmlrDmtojmga/vvIzlubbkuJTlpITlnKjkvJror53liJfooajnlYzpnaLkuIpcclxuICBpZiAobmV3TXNnTGlzdCAmJiBjb250YWN0TGlzdFRoYXQpIHtcclxuICAgIGNvbnRhY3RMaXN0VGhhdC5pbml0UmVjZW50Q29udGFjdExpc3QoKVxyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOiOt+WPluiBiuWkqeWOhuWPsuiusOW9lVxyXG4gKi9cclxuZnVuY3Rpb24gZ2V0QzJDSGlzdG9yeU1zZ3MoY2JPaykge1xyXG4gIGltLkxvZy53YXJuKCflvIDlp4vojrflj5bogYrlpKnljoblj7LorrDlvZUnKVxyXG4gIHZhciB0aGF0ID0gdGhpc1xyXG4gIGN1cnJlbnRNc2dzQXJyYXkgPSBbXVxyXG4gIHZhciByZXFNc2dDb3VudCA9IDEwIC8vIOaLieWPlua2iOaBr+adoeaVsFxyXG4gIHZhciBsYXN0TXNnVGltZSA9IHd4LnNldFN0b3JhZ2VTeW5jKCdsYXN0TXNnVGltZScpIHx8IDAgLy8g5pyA5ZCO5LiA5qyh5ouJ5Y+W5Y6G5Y+y5raI5oGv55qE5pe26Ze0XHJcbiAgdmFyIG1zZ0tleSA9IHd4LmdldFN0b3JhZ2VTeW5jKCdtc2dLZXknKSB8fCAnJyBcclxuICB2YXIgb3B0aW9ucyA9IHtcclxuICAgICdQZWVyX0FjY291bnQnOiBmcmllbmRJZCwgLy8g5aW95Y+L5biQ5Y+3XHJcbiAgICAnTWF4Q250JzogcmVxTXNnQ291bnQsIC8vIOaLieWPlua2iOaBr+adoeaVsFxyXG4gICAgJ0xhc3RNc2dUaW1lJzogbGFzdE1zZ1RpbWUsIC8vIOacgOi/keeahOa2iOaBr+aXtumXtO+8jOWNs+S7jui/meS4quaXtumXtOeCueWQkeWJjeaLieWPluWOhuWPsua2iOaBr1xyXG4gICAgJ01zZ0tleSc6IG1zZ0tleVxyXG4gIH1cclxuICAvLyDnnJ/mraPojrflj5bljoblj7Lmtojmga/nmoTmlrnms5Ug5Lqk55Sx5a6e6ZmF6LCD55So6ICF5aSE55CG5pWw5o2uXHJcbiAgaW0uZ2V0QzJDSGlzdG9yeU1zZ3Mob3B0aW9ucywgZnVuY3Rpb24gKHJlc3ApIHtcclxuICAgIGNiT2socmVzcClcclxuICB9KVxyXG4gIC8v5raI5oGv5bey6K+75LiK5oql77yM5Lul5Y+K6K6+572u5Lya6K+d6Ieq5Yqo5bey6K+75qCH6K6wXHJcbiAgdmFyIHNlc3NNYXAgPSBpbS5Nc2dTdG9yZS5zZXNzTWFwKClcclxuICBmb3IodmFyIGkgaW4gc2Vzc01hcCkge1xyXG4gICAgdmFyIHNlc3MgPSBzZXNzTWFwW2ldO1xyXG4gICAgaWYgKGZyaWVuZElkID09IHNlc3MuaWQoKSkge1xyXG4gICAgICBpbS5zZXRBdXRvUmVhZChzZXNzLCB0cnVlLCB0cnVlKVxyXG4gICAgfVxyXG4gIH1cclxuICBpbS5Mb2cud2Fybign6I635Y+W6IGK5aSp5Y6G5Y+y57qq5b2V5a6M5q+VJylcclxufVxyXG5cclxuLyoqXHJcbiAqIOWPkemAgea2iOaBryjmma7pgJrmtojmga8pXHJcbiAqL1xyXG5mdW5jdGlvbiBvblNlbmRNc2cobXNnLCBjYk9rLCBjYkVycikge1xyXG4gIC8v6I635Y+W5raI5oGv5YaF5a65XHJcbiAgdmFyIG1zZ3Rvc2VuZCA9IG1zZztcclxuICAvLyDliJvlu7rkvJror53lr7nosaFcclxuICBpZiAoIXNlbFNlc3MpIHtcclxuICAgIHNlbFNlc3MgPSBuZXcgaW0uU2Vzc2lvbihzZWxUeXBlLCBmcmllbmRJZCwgZnJpZW5kTmFtZSwgZnJpZW5kQXZhdGFyVXJsLCBNYXRoLnJvdW5kKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCkpO1xyXG4gIH1cclxuICB2YXIgaXNTZW5kID0gdHJ1ZTsvLyDmmK/lkKbkuLroh6rlt7Hlj5HpgIFcclxuICB2YXIgc2VxID0gLTE7IC8vIOa2iOaBr+W6j+WIl++8jC0xIOihqOekuiBzZGsg6Ieq5Yqo55Sf5oiQ77yM55So5LqO5Y676YeNXHJcbiAgdmFyIHJhbmRvbSA9IE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIDQyOTQ5NjcyOTYpOyAvLyDmtojmga/pmo/mnLrmlbDvvIznlKjkuo7ljrvph41cclxuICB2YXIgbXNnVGltZSA9IERhdGUucGFyc2UobmV3IERhdGUoKSkgLyAxMDAwOyAvLyDmtojmga/ml7bpl7TmiLNcclxuICB2YXIgc3ViVHlwZSA9IGltLkMyQ19NU0dfU1VCX1RZUEUuQ09NTU9OOyAvLyDmtojmga/lrZDnsbvlnosgYzJjIOa2iOaBr+aXtu+8jOWPguiAgyBjMmMg5raI5oGv5a2Q57G75Z6L5a+56LGh77yaaW0uQzJDX01TR19TVUJfVFlQRSBcclxuICAvLyBsb2dpbkluZm8uaWRlbnRpZmllciDmtojmga/lj5HpgIHogIXotKblj7csbG9naW5JbmZvLmlkZW50aWZpZXJOaWNrIOa2iOaBr+WPkemAgeiAheaYteensFxyXG4gIHZhciBtc2cgPSBuZXcgaW0uTXNnKHNlbFNlc3MsIGlzU2VuZCwgc2VxLCByYW5kb20sIG1zZ1RpbWUsIGltSWQsIHN1YlR5cGUsIGltTmFtZSk7XHJcbiAgdmFyIHRleHRPYmogPSBuZXcgaW0uTXNnLkVsZW0uVGV4dChtc2d0b3NlbmQpO1xyXG4gIG1zZy5hZGRUZXh0KHRleHRPYmopO1xyXG4gIGltLnNlbmRNc2cobXNnLCBmdW5jdGlvbiAocmVzcCkge1xyXG4gICAgY2JPaygpXHJcbiAgfSwgZnVuY3Rpb24gKGVycikge1xyXG4gICAgY2JFcnIoZXJyKVxyXG4gIH0pXHJcbn1cclxuXHJcbi8qKlxyXG4gKiDliJ3lp4vljJYgaW1cclxuICovXHJcbmZ1bmN0aW9uIGluaXQob3B0cykge1xyXG4gIGFjY291bnRNb2RlID0gb3B0cy5hY2NvdW50TW9kZVxyXG4gIGFjY291bnRUeXBlID0gb3B0cy5hY2NvdW50VHlwZVxyXG4gIHNka0FwcElEID0gb3B0cy5zZGtBcHBJRFxyXG4gIHNlbFR5cGUgPSBvcHRzLnNlbFR5cGVcclxuICBpbUlkID0gb3B0cy5pbUlkXHJcbiAgaW1OYW1lID0gb3B0cy5pbU5hbWVcclxuICBpbUF2YXRhclVybCA9IG9wdHMuaW1BdmF0YXJVcmxcclxuICBmcmllbmRJZCA9IG9wdHMuZnJpZW5kSWRcclxuICBmcmllbmROYW1lID0gb3B0cy5mcmllbmROYW1lXHJcbiAgZnJpZW5kQXZhdGFyVXJsID0gb3B0cy5mcmllbmRBdmF0YXJVcmxcclxuICBjb250YWN0TGlzdFRoYXQgPSBvcHRzLmNvbnRhY3RMaXN0VGhhdFxyXG4gIGNoYXRUaGF0ID0gb3B0cy5jaGF0VGhhdFxyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICBpbml0OiBpbml0LFxyXG4gIGxvZ2luOiBsb2dpbixcclxuICBvbk1zZ05vdGlmeTogb25Nc2dOb3RpZnksXHJcbiAgZ2V0QzJDSGlzdG9yeU1zZ3M6IGdldEMyQ0hpc3RvcnlNc2dzLFxyXG4gIG9uU2VuZE1zZzogb25TZW5kTXNnXHJcbn0iXX0=